# THIS FILE IS AUTOGENERATED -- DO NOT EDIT       #
# Edit and Re-run .ci/gitlab/config_template.py instead  #
stages:
  - sanity
  - images
  - cpp
  - headercheck
  - python
  - wheels
  - test
  - publish

variables:
    # only the image builder needs the subdirs checked out
    GIT_SUBMODULE_STRATEGY: none
    TRAVIS_BRANCH: ${CI_COMMIT_REF_NAME}
    TRAVIS_COMMIT: ${CI_COMMIT_SHA}
    CCACHE_BASEDIR: ${CI_PROJECT_DIR}
    CCACHE_DIR: "${CI_PROJECT_DIR}/.ccache"
    CCACHE_COMPILERCHECK: content
    CCACHE_COMPRESS: "true"
    PYTEST_ADDOPTS: "-s"
    MY_MODULE: dune-gdt
    ML_TAG: 517eb0fc771b81afc4484d17442d066d96531f03
    WHEEL_DIR: ${CI_PROJECT_DIR}/wheelhouse
    DUNE_BUILD_DIR: ${CI_PROJECT_DIR}/build
    DUNE_SRC_DIR: ${CI_PROJECT_DIR}

.image_builder:
    tags:
      - docker-in-docker
      - long execution time
    stage: images
    rules:
        - if: '$CI_COMMIT_REF_NAME =~ /^staging.*/'
          when: never
        - when: on_success
    retry:
        max: 2
        when:
            - runner_system_failure
            - stuck_or_timeout_failure
            - api_failure
    image: harbor.uni-muenster.de/proxy-docker/library/docker:19.03.12
    variables:
        DOCKER_HOST: tcp://docker:2375/
        DOCKER_DRIVER: overlay2
        IMAGE_NAME: ${CI_REGISTRY_IMAGE}/ci_testing_${CI_IMAGE}_${COMPILER}
        IMAGE: ${CI_REGISTRY_IMAGE}/ci_testing_${CI_IMAGE}_${COMPILER}:${CI_COMMIT_SHA}
        GIT_SUBMODULE_STRATEGY: recursive
    before_script:
      - |
        docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
        apk --update add py3-pip openssh-client rsync git file bash python3 curl
        pip3 install -U docker jinja2 docopt
    script:
      - |
        git submodule update --init --recursive
        docker build --cache-from=${IMAGE_NAME}:${CI_COMMIT_BEFORE_SHA} --build-arg BUILD_CXX=${CXX} --build-arg BUILD_CC=${CC} --build-arg DEBIAN_BASE=${CI_IMAGE} --build-arg BUILD_OPTS=${OPTS} -t ${IMAGE} -f deps/Dockerfile deps/
        docker push ${IMAGE}
    services:
        - name: harbor.uni-muenster.de/proxy-docker/library/docker:dind
          alias: docker

.subdir-test:
    tags:
      - amm-only
    stage: test
    rules:
        - if: '$CI_COMMIT_REF_NAME =~ /^staging.*/'
          when: never
        - when: on_success
    retry:
        max: 2
        when:
            - runner_system_failure
            - stuck_or_timeout_failure
            - api_failure
    image: ${CI_REGISTRY_IMAGE}/ci_testing_${CI_IMAGE}_${COMPILER}:${CI_COMMIT_SHA}
    cache:
      - key: "${CI_IMAGE}_${COMPILER}"
        paths:
          - .ccache
      - key: "${CI_IMAGE}"
        paths:
          - .cache/
    before_script:
      - |
        mkdir ./testresults && chmod -R 777 ./testresults
        ccache --zero-stats || true
    after_script:
      - ccache --show-stats
    artifacts:
      reports:
        junit: './testresults/*xml'

.pre-commit:
    stage: sanity
    retry:
        max: 2
        when:
            - runner_system_failure
            - stuck_or_timeout_failure
            - api_failure
    image: "harbor.uni-muenster.de/proxy-docker/library/python:3.9"
    cache:
      paths:
        - ${CI_PROJECT_DIR}/.cache/pre-commit
    variables:
        PRECOMMIT: "pre-commit run --all"
    before_script:
        - pip install pre-commit
        - pre-commit install --install-hooks


        
        - ${PRECOMMIT} debug-statements
        - ${PRECOMMIT} check-yaml #}


debian gcc:
    extends: .image_builder
    variables:
        CI_IMAGE: debian
        COMPILER: gcc
        CC: gcc
        CXX: g++
        OPTS: travis.ninja
debian clang:
    extends: .image_builder
    variables:
        CI_IMAGE: debian
        COMPILER: clang
        CC: clang
        CXX: clang++
        OPTS: travis.ninja



common gcc  cpp:
    extends: .subdir-test
    variables:
        CI_IMAGE: debian
        COMPILER: gcc
        TESTS_MODULE_SUBDIR: common
    stage: cpp
    needs: ["debian gcc"]
    script:
          - ./.ci/gitlab/test_cpp.bash

common gcc  headercheck:
    extends: .subdir-test
    variables:
        CI_IMAGE: debian
        COMPILER: gcc
        TESTS_MODULE_SUBDIR: common
    stage: headercheck
    needs: ["debian gcc"]
    script:
          - ./.ci/gitlab/test_headercheck.bash

grid gcc  cpp:
    extends: .subdir-test
    variables:
        CI_IMAGE: debian
        COMPILER: gcc
        TESTS_MODULE_SUBDIR: grid
    stage: cpp
    needs: ["debian gcc"]
    script:
          - ./.ci/gitlab/test_cpp.bash

grid gcc  headercheck:
    extends: .subdir-test
    variables:
        CI_IMAGE: debian
        COMPILER: gcc
        TESTS_MODULE_SUBDIR: grid
    stage: headercheck
    needs: ["debian gcc"]
    script:
          - ./.ci/gitlab/test_headercheck.bash


functions gcc  headercheck:
    extends: .subdir-test
    variables:
        CI_IMAGE: debian
        COMPILER: gcc
        TESTS_MODULE_SUBDIR: functions
    stage: headercheck
    needs: ["debian gcc"]
    script:
          - ./.ci/gitlab/test_headercheck.bash

functions1 gcc  cpp:
    extends: .subdir-test
    variables:
        CI_IMAGE: debian
        COMPILER: gcc
        TESTS_MODULE_SUBDIR: functions1
    stage: cpp
    needs: ["debian gcc"]
    script:
          - ./.ci/gitlab/test_cpp.bash


functions2 gcc  cpp:
    extends: .subdir-test
    variables:
        CI_IMAGE: debian
        COMPILER: gcc
        TESTS_MODULE_SUBDIR: functions2
    stage: cpp
    needs: ["debian gcc"]
    script:
          - ./.ci/gitlab/test_cpp.bash


la gcc  cpp:
    extends: .subdir-test
    variables:
        CI_IMAGE: debian
        COMPILER: gcc
        TESTS_MODULE_SUBDIR: la
    stage: cpp
    needs: ["debian gcc"]
    script:
          - ./.ci/gitlab/test_cpp.bash

la gcc  headercheck:
    extends: .subdir-test
    variables:
        CI_IMAGE: debian
        COMPILER: gcc
        TESTS_MODULE_SUBDIR: la
    stage: headercheck
    needs: ["debian gcc"]
    script:
          - ./.ci/gitlab/test_headercheck.bash

gdt gcc  cpp:
    extends: .subdir-test
    variables:
        CI_IMAGE: debian
        COMPILER: gcc
        TESTS_MODULE_SUBDIR: gdt
    stage: cpp
    needs: ["debian gcc"]
    script:
          - ./.ci/gitlab/test_cpp.bash

gdt gcc  headercheck:
    extends: .subdir-test
    variables:
        CI_IMAGE: debian
        COMPILER: gcc
        TESTS_MODULE_SUBDIR: gdt
    stage: headercheck
    needs: ["debian gcc"]
    script:
          - ./.ci/gitlab/test_headercheck.bash

common clang  cpp:
    extends: .subdir-test
    variables:
        CI_IMAGE: debian
        COMPILER: clang
        TESTS_MODULE_SUBDIR: common
    stage: cpp
    needs: ["debian clang"]
    script:
          - ./.ci/gitlab/test_cpp.bash

common clang  headercheck:
    extends: .subdir-test
    variables:
        CI_IMAGE: debian
        COMPILER: clang
        TESTS_MODULE_SUBDIR: common
    stage: headercheck
    needs: ["debian clang"]
    script:
          - ./.ci/gitlab/test_headercheck.bash

grid clang  cpp:
    extends: .subdir-test
    variables:
        CI_IMAGE: debian
        COMPILER: clang
        TESTS_MODULE_SUBDIR: grid
    stage: cpp
    needs: ["debian clang"]
    script:
          - ./.ci/gitlab/test_cpp.bash

grid clang  headercheck:
    extends: .subdir-test
    variables:
        CI_IMAGE: debian
        COMPILER: clang
        TESTS_MODULE_SUBDIR: grid
    stage: headercheck
    needs: ["debian clang"]
    script:
          - ./.ci/gitlab/test_headercheck.bash


functions clang  headercheck:
    extends: .subdir-test
    variables:
        CI_IMAGE: debian
        COMPILER: clang
        TESTS_MODULE_SUBDIR: functions
    stage: headercheck
    needs: ["debian clang"]
    script:
          - ./.ci/gitlab/test_headercheck.bash

functions1 clang  cpp:
    extends: .subdir-test
    variables:
        CI_IMAGE: debian
        COMPILER: clang
        TESTS_MODULE_SUBDIR: functions1
    stage: cpp
    needs: ["debian clang"]
    script:
          - ./.ci/gitlab/test_cpp.bash


functions2 clang  cpp:
    extends: .subdir-test
    variables:
        CI_IMAGE: debian
        COMPILER: clang
        TESTS_MODULE_SUBDIR: functions2
    stage: cpp
    needs: ["debian clang"]
    script:
          - ./.ci/gitlab/test_cpp.bash


la clang  cpp:
    extends: .subdir-test
    variables:
        CI_IMAGE: debian
        COMPILER: clang
        TESTS_MODULE_SUBDIR: la
    stage: cpp
    needs: ["debian clang"]
    script:
          - ./.ci/gitlab/test_cpp.bash

la clang  headercheck:
    extends: .subdir-test
    variables:
        CI_IMAGE: debian
        COMPILER: clang
        TESTS_MODULE_SUBDIR: la
    stage: headercheck
    needs: ["debian clang"]
    script:
          - ./.ci/gitlab/test_headercheck.bash

gdt clang  cpp:
    extends: .subdir-test
    variables:
        CI_IMAGE: debian
        COMPILER: clang
        TESTS_MODULE_SUBDIR: gdt
    stage: cpp
    needs: ["debian clang"]
    script:
          - ./.ci/gitlab/test_cpp.bash

gdt clang  headercheck:
    extends: .subdir-test
    variables:
        CI_IMAGE: debian
        COMPILER: clang
        TESTS_MODULE_SUBDIR: gdt
    stage: headercheck
    needs: ["debian clang"]
    script:
          - ./.ci/gitlab/test_headercheck.bash





.wheels_base:
  variables:
    GIT_SUBMODULE_STRATEGY: recursive
    LOCAL_UID: 0
    TWINE_PASSWORD: ${CI_JOB_TOKEN}
    TWINE_USERNAME: gitlab-ci-token
    GITLAB_PYPI: ${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/pypi/
  stage: wheels
  image: zivgitlab.wwu.io/ag-ohlberger/dune-community/docker/manylinux-2014_py${GDT_PYTHON_VERSION}:${ML_TAG}
  needs: []
  cache:
    paths:
      - ccache
    when: 'always'
    key: ${GDT_PYTHON_VERSION}_${ML_TAG}
  artifacts:
    expire_in: 1 day
    paths:
      - ninja_log_*.tar.gz
      - ${WHEEL_DIR}/final/dune*whl
  after_script:
    - tar cfz ninja_log_${STEP}_${GDT_PYTHON_VERSION}.tar.gz ${DUNE_BUILD_DIR}/dune-*/.ninja_log || true

.test_base:
  image: harbor.uni-muenster.de/proxy-docker/library/python:${GDT_PYTHON_VERSION}-slim
  stage: test
  script:
    - pip install ${WHEEL_DIR}/final/dune*whl
    - python -c 'from dune.xt import *'
    - python -c 'from dune.gdt import *'
xt 3.7:
  extends: .wheels_base
  variables:
    GDT_PYTHON_VERSION: "3.7"
    STEP: xt
  needs:
  - all 3.7
  dependencies: ["all 3.7"]
  script: ./.ci/make_wheels.bash xt
  after_script:
  - ccache --show-stats
gdt 3.7:
  extends: .wheels_base
  variables:
    GDT_PYTHON_VERSION: "3.7"
    STEP: gdt
  needs:
  - all 3.7
  - xt 3.7
  dependencies: ["all 3.7"]
  script: ./.ci/make_wheels.bash gdt
  after_script:
  - ccache --show-stats
all 3.7:
  extends: .wheels_base
  variables:
    GDT_PYTHON_VERSION: "3.7"
    STEP: all
  script: ./.ci/make_wheels.bash all
  after_script:
  - ccache --show-stats

  artifacts:
    paths:
      - ${DUNE_BUILD_DIR}




wheel collect 3.7:
  stage: wheels
  variables:
    GIT_SUBMODULE_STRATEGY: none
  dependencies:
    - "xt 3.7"
    - "gdt 3.7"
  needs:
    - "xt 3.7"
    - "gdt 3.7"
  image: harbor.uni-muenster.de/proxy-docker/library/alpine:3.15
  script:
    - rm -rf ${DUNE_BUILD_DIR}
  artifacts:
    paths:
      - ${WHEEL_DIR}/final/dune*whl

test wheels 3.7:
  extends: .test_base
  variables:
    GIT_SUBMODULE_STRATEGY: none
    GDT_PYTHON_VERSION: "3.7"
  needs: ["wheel collect 3.7",]
  dependencies: ["wheel collect 3.7",]
xt 3.8:
  extends: .wheels_base
  variables:
    GDT_PYTHON_VERSION: "3.8"
    STEP: xt
  needs:
  - all 3.8
  dependencies: ["all 3.8"]
  script: ./.ci/make_wheels.bash xt
  after_script:
  - ccache --show-stats
gdt 3.8:
  extends: .wheels_base
  variables:
    GDT_PYTHON_VERSION: "3.8"
    STEP: gdt
  needs:
  - all 3.8
  - xt 3.8
  dependencies: ["all 3.8"]
  script: ./.ci/make_wheels.bash gdt
  after_script:
  - ccache --show-stats
all 3.8:
  extends: .wheels_base
  variables:
    GDT_PYTHON_VERSION: "3.8"
    STEP: all
  script: ./.ci/make_wheels.bash all
  after_script:
  - ccache --show-stats

  artifacts:
    paths:
      - ${DUNE_BUILD_DIR}




wheel collect 3.8:
  stage: wheels
  variables:
    GIT_SUBMODULE_STRATEGY: none
  dependencies:
    - "xt 3.8"
    - "gdt 3.8"
  needs:
    - "xt 3.8"
    - "gdt 3.8"
  image: harbor.uni-muenster.de/proxy-docker/library/alpine:3.15
  script:
    - rm -rf ${DUNE_BUILD_DIR}
  artifacts:
    paths:
      - ${WHEEL_DIR}/final/dune*whl

test wheels 3.8:
  extends: .test_base
  variables:
    GIT_SUBMODULE_STRATEGY: none
    GDT_PYTHON_VERSION: "3.8"
  needs: ["wheel collect 3.8",]
  dependencies: ["wheel collect 3.8",]
xt 3.9:
  extends: .wheels_base
  variables:
    GDT_PYTHON_VERSION: "3.9"
    STEP: xt
  needs:
  - all 3.9
  dependencies: ["all 3.9"]
  script: ./.ci/make_wheels.bash xt
  after_script:
  - ccache --show-stats
gdt 3.9:
  extends: .wheels_base
  variables:
    GDT_PYTHON_VERSION: "3.9"
    STEP: gdt
  needs:
  - all 3.9
  - xt 3.9
  dependencies: ["all 3.9"]
  script: ./.ci/make_wheels.bash gdt
  after_script:
  - ccache --show-stats
all 3.9:
  extends: .wheels_base
  variables:
    GDT_PYTHON_VERSION: "3.9"
    STEP: all
  script: ./.ci/make_wheels.bash all
  after_script:
  - ccache --show-stats

  artifacts:
    paths:
      - ${DUNE_BUILD_DIR}




wheel collect 3.9:
  stage: wheels
  variables:
    GIT_SUBMODULE_STRATEGY: none
  dependencies:
    - "xt 3.9"
    - "gdt 3.9"
  needs:
    - "xt 3.9"
    - "gdt 3.9"
  image: harbor.uni-muenster.de/proxy-docker/library/alpine:3.15
  script:
    - rm -rf ${DUNE_BUILD_DIR}
  artifacts:
    paths:
      - ${WHEEL_DIR}/final/dune*whl

test wheels 3.9:
  extends: .test_base
  variables:
    GIT_SUBMODULE_STRATEGY: none
    GDT_PYTHON_VERSION: "3.9"
  needs: ["wheel collect 3.9",]
  dependencies: ["wheel collect 3.9",]

.publish:
  image: alpine:3.15
  dependencies:
  -  "wheel collect 3.7"
  -  "wheel collect 3.8"
  -  "wheel collect 3.9"
  needs:
  -  "wheel collect 3.7"
  -  "test wheels 3.7"
  -  "wheel collect 3.8"
  -  "test wheels 3.8"
  -  "wheel collect 3.9"
  -  "test wheels 3.9"
  stage: publish
  before_script:
      - apk --update add py3-pip git file bash python3 py3-cffi py3-cryptography
      - pip3 install -U twine
  variables:
    TWINE_PASSWORD: ${TWINE_PASSWORD}
    TWINE_USERNAME: ${TWINE_USERNAME}
  script:
    - cd ${MOD_DIR}
    - pwd
    - git describe --tags HEAD
    - git tag --list
    # upload only if a tag points to checked out commit
    - (git describe --exact-match --tags HEAD && python3 -m twine upload ${WHEEL_DIR}/final/${MOD_WHEEL_PREFIX}*whl) || echo "not uploading untagged wheels"
    - git checkout 2021.1.9
    - (git describe --exact-match --tags HEAD ) || echo "still not a tag"
  artifacts:
    paths:
      - ${WHEEL_DIR}/final/${MOD_WHEEL_PREFIX}*whl

publish dune-xt:
  extends: .publish
  variables:
    MOD_WHEEL_PREFIX: dune_xt
    MOD_DIR: dune-xt

publish dune-gdt:
  extends: .publish
  variables:
    MOD_WHEEL_PREFIX: dune_gdt
    MOD_DIR: dune-gdt